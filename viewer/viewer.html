<!-- viewer.html -->
<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>Viewer</title>
</head>

<body>
    <label>あなたのID: <input id="myId" value="viewer1"></label>
    <label>見る相手のID: <input id="targetId" value="broadcaster1"></label>
    <button id="connectBtn">接続要求</button>
    <video id="remoteVideo" autoplay playsinline style="width:480px;height:360px;background:#000"></video>

    <script>
        const wsUrl = 'ws://localhost:3000';
        const configuration = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        let ws = null;
        let pc = null;
        let myId = null;
        let targetId = null;

        document.getElementById('connectBtn').onclick = () => {
            myId = document.getElementById('myId').value || 'viewer1';
            targetId = document.getElementById('targetId').value || 'broadcaster1';
            ws = new WebSocket(wsUrl);
            ws.onopen = () => {
                ws.send(JSON.stringify({ type: 'register', id: myId, role: 'viewer' }));
                // ask broadcaster to create offer for us
                ws.send(JSON.stringify({ target: targetId, kind: 'viewer-join', payload: null }));
            };
            ws.onmessage = async (ev) => {
                const msg = JSON.parse(ev.data);
                if (msg.payload && msg.kind === 'offer') {
                    await handleOffer(msg.from, msg.payload);
                } else if (msg.payload && msg.kind === 'candidate') {
                    if (pc) pc.addIceCandidate(new RTCIceCandidate(msg.payload));
                }
            };
        };

        async function handleOffer(fromId, offer) {
            pc = new RTCPeerConnection(configuration);
            pc.ontrack = (e) => {
                document.getElementById('remoteVideo').srcObject = e.streams[0];
            };
            pc.onicecandidate = (e) => {
                if (e.candidate) {
                    ws.send(JSON.stringify({ target: fromId, kind: 'candidate', payload: e.candidate }));
                }
            };
            await pc.setRemoteDescription(new RTCSessionDescription(offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            ws.send(JSON.stringify({ target: fromId, kind: 'answer', payload: pc.localDescription }));
        }
    </script>
</body>

</html>