<!-- viewer.html -->
<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>Viewer</title>
</head>

<body>
    <label>あなたのID: <input id="myId" value="viewer1"></label>
    <label>見る相手のID: <input id="targetId" value="broadcaster1"></label>
    <label>サーバーIP: <input id="serverHost" value="localhost"></label>
    <button id="connectBtn">接続要求</button>
    <button id="disconnectBtn" disabled>接続終了</button>
    <div id="status">未接続</div>
    <video id="remoteVideo" autoplay playsinline style="width:480px;height:360px;background:#000"></video>

    <script>
        const configuration = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        let ws = null;
        let pc = null;
        let myId = null;
        let targetId = null;

        function updateStatus(msg) {
            document.getElementById('status').textContent = msg;
            console.log('Status:', msg);
        }

        function updateButtons(isConnected) {
            document.getElementById('connectBtn').disabled = isConnected;
            document.getElementById('disconnectBtn').disabled = !isConnected;
        }

        function disconnectViewer() {
            console.log('視聴者側で接続を終了');

            // PeerConnection接続を閉じる
            if (pc) {
                pc.close();
                pc = null;
            }

            // ビデオ要素をクリア
            document.getElementById('remoteVideo').srcObject = null;

            // WebSocket接続を閉じる
            if (ws) {
                ws.close();
                ws = null;
            }

            updateStatus('接続終了');
            updateButtons(false);
        }

        document.getElementById('connectBtn').onclick = () => {
            myId = document.getElementById('myId').value || 'viewer1';
            targetId = document.getElementById('targetId').value || 'broadcaster1';
            const serverHost = document.getElementById('serverHost').value || 'localhost';
            const wsUrl = `wss://${serverHost}:3000`;

            updateStatus('WebSocketに接続中...');
            console.log(`接続試行: ${wsUrl}`);
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                updateStatus('WebSocket接続完了。登録中...');
                console.log('WebSocket接続が開かれました');
                ws.send(JSON.stringify({ type: 'register', id: myId, role: 'viewer' }));
                updateStatus('配信者に接続要求を送信...');
                console.log(`配信者 ${targetId} に接続要求を送信`);
                ws.send(JSON.stringify({ target: targetId, kind: 'viewer-join', payload: null }));
                updateButtons(true);
            };

            ws.onmessage = async (ev) => {
                const msg = JSON.parse(ev.data);
                console.log('受信メッセージ:', msg);

                if (msg.payload && msg.kind === 'offer') {
                    updateStatus('Offerを受信。応答中...');
                    await handleOffer(msg.from, msg.payload);
                } else if (msg.payload && msg.kind === 'candidate') {
                    console.log('ICE候補を受信:', msg.payload);
                    if (pc) pc.addIceCandidate(new RTCIceCandidate(msg.payload));
                } else if (msg.kind === 'stream-ended') {
                    console.log('配信者が配信を終了しました');
                    updateStatus('配信が終了されました');
                    document.getElementById('remoteVideo').srcObject = null;
                    if (pc) {
                        pc.close();
                        pc = null;
                    }
                    updateButtons(false);
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocketエラー:', error);
                updateStatus('WebSocket接続エラー');
                updateButtons(false);
            };

            ws.onclose = () => {
                updateStatus('WebSocket接続が閉じられました');
                updateButtons(false);
            };
        };

        document.getElementById('disconnectBtn').onclick = () => {
            disconnectViewer();
        };

        async function handleOffer(fromId, offer) {
            console.log('Offerを処理中:', offer);
            updateStatus('PeerConnection作成中...');

            pc = new RTCPeerConnection(configuration);

            pc.ontrack = (e) => {
                console.log('トラックを受信:', e.streams);
                updateStatus('映像ストリーム受信中');
                document.getElementById('remoteVideo').srcObject = e.streams[0];
            };

            pc.onicecandidate = (e) => {
                if (e.candidate) {
                    console.log('ICE候補を送信:', e.candidate);
                    ws.send(JSON.stringify({ target: fromId, kind: 'candidate', payload: e.candidate }));
                }
            };

            pc.onconnectionstatechange = () => {
                console.log('接続状態:', pc.connectionState);
                updateStatus(`接続状態: ${pc.connectionState}`);

                if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {
                    updateStatus('接続が切断されました');
                    document.getElementById('remoteVideo').srcObject = null;
                    updateButtons(false);
                }
            };

            pc.oniceconnectionstatechange = () => {
                console.log('ICE接続状態:', pc.iceConnectionState);
            };

            try {
                await pc.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                console.log('Answerを送信:', answer);
                ws.send(JSON.stringify({ target: fromId, kind: 'answer', payload: pc.localDescription }));
                updateStatus('Answerを送信完了');
            } catch (error) {
                console.error('Offer処理エラー:', error);
                updateStatus('接続エラー: ' + error.message);
            }
        }
    </script>
</body>

</html>