<!-- broadcaster.html -->
<!doctype html>
<html>
<head><meta charset="utf-8"><title>Broadcaster</title></head>
<body>
  <label>あなたのID: <input id="myId" value="broadcaster1"></label>
  <button id="startBtn">カメラ開始 & サーバ接続</button>
  <video id="localVideo" autoplay playsinline muted style="width:320px;height:240px;background:#000"></video>

<script>
const wsUrl = 'ws://localhost:3000';
const configuration = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

let pcMap = new Map(); // viewerId -> RTCPeerConnection
let localStream = null;
let ws = null;
let myId = null;

document.getElementById('startBtn').onclick = async () => {
  myId = document.getElementById('myId').value || 'broadcaster1';
  localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
  document.getElementById('localVideo').srcObject = localStream;

  ws = new WebSocket(wsUrl);
  ws.onopen = () => {
    ws.send(JSON.stringify({ type: 'register', id: myId, role: 'broadcaster' }));
  };
  ws.onmessage = async (ev) => {
    const msg = JSON.parse(ev.data);
    if(msg.kind === 'viewer-join'){ // viewer asks to start
      const viewerId = msg.from;
      await createOfferForViewer(viewerId);
    } else if(msg.payload && msg.kind === 'answer'){
      const viewerId = msg.from;
      const pc = pcMap.get(viewerId);
      if(!pc) return;
      await pc.setRemoteDescription(new RTCSessionDescription(msg.payload));
    } else if(msg.payload && msg.kind === 'candidate'){
      const pc = pcMap.get(msg.from);
      if(pc) pc.addIceCandidate(new RTCIceCandidate(msg.payload));
    }
  };
};

async function createOfferForViewer(viewerId){
  const pc = new RTCPeerConnection(configuration);
  // send local tracks
  for(const t of localStream.getTracks()) pc.addTrack(t, localStream);
  pc.onicecandidate = (e) => {
    if(e.candidate){
      ws.send(JSON.stringify({ target: viewerId, kind: 'candidate', payload: e.candidate }));
    }
  };
  pcMap.set(viewerId, pc);
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  ws.send(JSON.stringify({ target: viewerId, kind: 'offer', payload: pc.localDescription }));
}
</script>
</body>
</html>
